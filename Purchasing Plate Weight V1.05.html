<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cut List Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; background: #f9f9f9; color: #333; padding: 20px; }
    h2 {
      background-color: #002f5d;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    h2 img { height: 40px; width: auto; max-width: 100%; }
    #drop-area {
      border: 2px dashed #0077cc;
      background: #eef5fb;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      border-radius: 10px;
    }
    canvas { border: 1px dashed #ccc; margin: 10px auto; display: block; background: #fff; }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th {
      background-color: #0077cc;
      color: white;
      padding: 12px;
    }
    td {
      padding: 10px;
      border-top: 1px solid #ddd;
    }
    #summary {
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
      color: #002f5d;
    }
    button {
      background-color: #0077cc;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 10px 10px 0 0;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover { background-color: #005fa3; }
    #debug {
      display: none;
      white-space: pre-wrap;
      font-family: monospace;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      margin-top: 20px;
      border-radius: 5px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
<h2><img src="https://nwsfab.com/wp-content/themes/nwsfab/img/logo.svg" alt="NWSFab Logo">Cut List Calculator</h2>
<div id="drop-area">
  <p><strong>Drop your PDF here</strong></p>
  <input type="file" id="fileElem" accept="application/pdf" />
</div>
<canvas id="pdf-canvas"></canvas>
<div id="output"></div>
<div id="summary"></div>
<div id="debug"></div>
<button id="download" style="display:none">Download as Excel</button>
<button id="downloadPdf" style="display:none">Download as PDF</button>
<button id="toggleDebug">Show Debug Log</button>

<script>
const fileElem = document.getElementById("fileElem");
const output = document.getElementById("output");
const summary = document.getElementById("summary");
const debug = document.getElementById("debug");
const canvas = document.getElementById("pdf-canvas");
const ctx = canvas.getContext("2d");
const downloadBtn = document.getElementById("download");
const downloadPdfBtn = document.getElementById("downloadPdf");
const toggleDebug = document.getElementById("toggleDebug");
let cleanData = [];

toggleDebug.addEventListener("click", () => {
  debug.style.display = debug.style.display === "none" ? "block" : "none";
  toggleDebug.innerText = debug.style.display === "none" ? "Show Debug Log" : "Hide Debug Log";
});

fileElem.addEventListener("change", e => handleFiles(e.target.files));

function handleFiles(files) {
  const file = files[0];
  const reader = new FileReader();
  reader.onload = function() {
    const typedarray = new Uint8Array(this.result);
    pdfjsLib.getDocument({data: typedarray}).promise.then(async pdf => {
      let extractedLines = [];
      let debugLog = [];



      debug.innerText = debugLog.join("\n");
      processText(extractedLines);
    });
  };
  reader.readAsArrayBuffer(file);
}

function processText(lines) {
  cleanData = [];
  let totalWeight = 0;

  lines.forEach(line => {
    const num = parseFloat(line.replace(/[^0-9.]/g, ""));
    if (!isNaN(num) && num > 0) {
      cleanData.push({ weight: num });
      totalWeight += num;
    }
  });

  let html = '<table><tr><th>Weight (lbs)</th></tr>';
  cleanData.forEach(row => {
    html += `<tr><td>${row.weight.toLocaleString()}</td></tr>`;
  });
  html += '</table>';
  output.innerHTML = html;
  summary.innerText = `Total Weight: ${totalWeight.toLocaleString()} lbs | Estimated Cost: $${(totalWeight * 0.95).toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
  downloadBtn.style.display = "inline-block";
  downloadPdfBtn.style.display = "inline-block";
}

downloadBtn.addEventListener("click", () => {
  const ws = XLSX.utils.json_to_sheet(cleanData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Weights");
  XLSX.writeFile(wb, "cleaned_weights.xlsx");
});

downloadPdfBtn.addEventListener("click", () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(10);
  let y = 10;
  cleanData.forEach(row => {
    doc.text(`Weight: ${row.weight.toLocaleString()} lbs`, 10, y);
    y += 7;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });
  doc.save("cleaned_weights.pdf");
});
</script>
</body>
</html>
